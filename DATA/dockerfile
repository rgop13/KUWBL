FROM nvidia/cuda:12.9.1-cudnn-devel-ubuntu22.04

USER root
# ---- OS 패키지 --------------------------------------------------
RUN apt-get update && \
DEBIAN_FRONTEND=noninteractive \
apt-get install -y --no-install-recommends libibverbs1 openssh-client git curl ca-certificates sudo vim && rm -rf /var/lib/apt/lists/*

# Python & 빌드 툴
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
      python3 python3-pip python3-venv python3-dev \
      build-essential pkg-config \
    && rm -rf /var/lib/apt/lists/*

# pip 업그레이드
RUN python3 -m pip install --upgrade pip setuptools wheel

# 기본 editor를 vim으로 설정(실패해도 빌드 진행)
RUN update-alternatives --set editor /usr/bin/vim.basic || true

RUN pip install --no-cache-dir torch==2.7.1 torchvision==0.22.1 torchaudio==2.7.1 --index-url https://download.pytorch.org/whl/cu128 && pip install --no-cache-dir flash-attn --no-build-isolation
RUN pip install --no-cache-dir xformers flashinfer-python ray[serve-grpc,client] openai huggingface-hub
RUN pip install --no-cache-dir transformers && pip install --no-cache-dir pydantic==2.11.7 && pip install --no-cache-dir gymnasium dm-tree && pip install --no-cache-dir vllm && pip install --no-cache-dir flash-attn --no-build-isolation && pip install --no-cache-dir pyarrow pandas lz4
RUN mkdir -p /opt/WBL/DATA/serving

WORKDIR /opt/WBL/DATA/serving

# --- UID/GID 500 사용자 생성 & sudo 권한 부여 --------------------
RUN groupadd -g 500 app || true && \
    id -u 500 >/dev/null 2>&1 || useradd -m -u 500 -g 500 -s /bin/bash app && \
    echo 'app ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/90-app && \
    chmod 0440 /etc/sudoers.d/90-app
# 고성능 스토리지 사용을 위해서는 UID 500, GID 500 권한 필요
USER 500:500 
COPY serving/serve_head_api.py /opt/WBL/DATA/serving/serve_head_api.py

# ---- (옵션) NCCL 안정화 -----------------------------------------------
ENV NCCL_ASYNC_ERROR_HANDLING=1 NCCL_LAUNCH_MODE=GROUP

# ---- Hugging Face / Transformers 캐시 경로 ----------------------------
ENV HF_HOME=/opt/cache/huggingface \
TRANSFORMERS_CACHE=/opt/cache/huggingface/transformers \
HF_DATASETS_CACHE=/opt/cache/huggingface/datasets
RUN sudo mkdir -p /opt/cache/huggingface /opt/cache/huggingface/transformers /opt/cache/huggingface/datasets && sudo chown -R 500:500 /opt/cache